# Copyright (c) Codesphere Inc.
# SPDX-License-Identifier: Apache-2.0

# Clean Lima configuration for OMS development
vmType: "qemu"
os: "Linux"
arch: "x86_64"

# Ubuntu 24.04 LTS
images:
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
  arch: "x86_64"

# Resources
cpus: 4
memory: "8GiB"
disk: "60GiB"

# Mount your OMS project
mounts:
- location: "~"
  mountPoint: "/home/user/host-home"
  writable: true

# Ports and SSH
ssh:
  localPort: 60022
  loadDotSSHPubKeys: true
portForwards:
- guestPort: 8080
  hostPort: 8080

# containerd
containerd:
  system: false
  user: false

# Install Docker and Go
provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    
    # Update packages
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    
    # Install Docker
    curl -fsSL https://get.docker.com | sh
    systemctl disable --now docker
    apt-get install -y uidmap dbus-user-session

    # Install Go and build tools
    apt-get update
    apt-get install -y golang-go make git

- mode: user
  script: |
    #!/bin/bash
    set -eux -o pipefail
    
    # Install Docker in rootless mode
    dockerd-rootless-setuptool.sh install || true
    
    # Clone OMS repository locally for better build performance
    if [ ! -d ~/oms ]; then
      git clone https://github.com/codesphere-cloud/oms.git ~/oms
    fi

message: |
  Your OMS development environment is ready!
  
  To access it:
  ------
  limactl shell lima-oms
  cd oms
  ./oms-cli --help
  ------
  
  To build the CLI for Linux (from your Mac):
  ------
  make build-cli-linux
  ------

  To build the CLI inside lima:
  ------
  limactl shell lima-oms
  cd oms
  make build-cli
  ------

  To install k0s (run inside lima):
  ------
  limactl shell lima-oms
  cd oms
  ./oms-cli install k0s --install-config config.yaml --version v1.30.0+k0s.0 --force
  ------

  To test remote k0s installation (run inside lima):
  ------
  limactl shell lima-oms
  cd oms
  # Setup SSH for testing  
  ssh-keygen -t rsa -b 4096 -f ~/.ssh/test_key -N ""
  cat ~/.ssh/test_key.pub >> ~/.ssh/authorized_keys
  chmod 600 ~/.ssh/authorized_keys
  # Add host to known_hosts
  VM_IP=$(hostname -I | awk '{print $1}')
  ssh-keyscan $VM_IP >> ~/.ssh/known_hosts
  # Test SSH connection
  ssh -i ~/.ssh/test_key $VM_IP "echo 'SSH works'"
  # Note: Remote installation requires proper SSH host key verification
  # For testing, you can add the host to known_hosts (already done above with ssh-keyscan)
  ./oms-cli install k0s --install-config config.yaml --version v1.30.0+k0s.0 \
    --remote-host $VM_IP --remote-user $(whoami) --ssh-key-path ~/.ssh/test_key --force
  ------

  To install Codesphere (run inside lima):
  ------
  limactl shell lima-oms
  cd oms
  ./oms-cli install codesphere --package codesphere-v1.66.0-installer --install-config config.yaml --priv-key ./path-to-private-key
  ------
